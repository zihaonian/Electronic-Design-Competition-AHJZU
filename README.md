## 摘要

​		随着时代的进步和发展，单片机技术已经普及到我们生活，工作，科研，各个领域，已经成为一种比较成熟的技术。本文介绍了 DS18B20 数字温度传感器，DS1302 时钟模块，LCD1602 以及矩阵键盘在主控 STC89C52 控制下的硬件连接及 软件编程，并给出了软件流程图以及硬件原理图。

​		该系统由上位机和下位机两大部分组成。下位机中包含四种模式（学号显示 模式-温度及时间显示模式-时间修改模式-数据回查模式），此四种模式分别对应4 个交互界面（由显示终端 LCD1602 完成）。利用矩阵键盘中 S15 和 S16 来完成 界面切换（S16 用于学号显示模式-温度及时间显示模式切换，S15 用于时间修改 模式-数据回查模式切换）。配置定时器 0，50ms 产生一次中断，在中断服务函数 中定义计时计数变量 Count_i,计数为 200 时（即 10s）通过串口向上位机发送一 次温度时间数据。计数为 400 时（即 20s）记录一次时间与温度。在时间修改模 式中，通过矩阵键盘 S1 S5 S2 S6 S3 S7 S4 S8 S9 S13 S10 S14 分别完成对年， 月，日，时，分，秒的增减，实现时间修改。在数据回查模式中，通过矩阵键盘S8 与 S12 完成对数据的翻页查询。此外按下 S11 将会把查询界面的数据通过串 口发送给上位机，实现数据的回显功能。上位机部分使用了通用 PC。

​		该系统实现了温度测量，时间显示，时间修改，数据记录，数据回显等功能。

#### 关键词：温度测量   STC89C52   DS18B20   DS1302   单总线系统

## 文件结构

```
NUEDC/
│
├── Project/                    # 存放电子设计大赛比赛题目
├── res/                        # 存放readme.md图表文件
├── file_output/             	# 存放STC51工程文件				
├── SCH/                        # 电路原理图.pdf
│   ├── 简易温度测量系统SCH.svg
│   └── 简易温度测量系统SCH.pdf
├── result/                     # 存放测试结果.pdf
│   └── 上位机接收数据.txt
│
├── 设计报告/                     # 设计报告文件 
│   └── 设计报告.pdf
│
└── README.md                   # 本文档，提供测试方案与结果、系统总体设计以及文件结构等信息
```

##  前言

​		了解到该系统的需求，为了将数据信息显示出来，采用了一块 LCD1602 液晶 显示屏，并通过编写函数完成初始化，能够完成显示目的。其次考虑的是完成温 度的测量，本系统采用 DS18B20 温度传感器采集温度数据，并配置实现单总线通 信读取温度数据，并通过 LCD1602 将温度数据显示出来。计时模块采用 DS1302实时时钟，该时钟内部带有备用电源，可以使时间数据掉电不丢失，并通过软件 编写程序，实现了通过按键设置显示时间的功能。为了完成与上位机的通信，配置了 UART 串口函数，最终，通过串口可以实现向上位机发送历史温度以及时间 数据，达到数据保存目的。至此该系统总体需求均已实现。

## 系统方案设计

### 方案一

 由于本设计是测温电路，可以使用热敏电阻之类的器件利用其感温效应，在将随被测温度变化的电压或电流采集过来，进行 A/D 转换后，就可以用单片机进 行数据的处理，在显示电路上，就可以将被测温度显示出来，这种设计需要用到A/D 转换电路，感温电路比较麻烦。

<div align=center><img  src ="https://github.com/zihaonian/Electronic-Design-Competition-AHJZU/blob/main/res/Scheme 1 System distribution diagram.jpg"/></div>

###  方案二

 对于测温器件的重新选择，考虑到用温度传感器，在单片机电路设计中，大多都是使用传感器，所以可以采用一只温度传感器 DS18B20，此传感器，可以很 容易直接读取被测温度值，进行转换，就可以满足设计要求。

<div align=center><img  src ="https://github.com/zihaonian/Electronic-Design-Competition-AHJZU/blob/main/res/Scheme 2 system distribution map.jpg"/></div>

 通过上述两种方案的设计以及流程图，可以看出，方案一通过热敏电阻采集 的温度数据需要额外搭载 AD 转换电路进行转化，方案二只需通过温度传感器即 可采集准确的温度数据。采用热敏电阻，可满足 40 摄氏度至 90 摄氏度测量范 围，但热敏电阻精度、重复性、可靠性较差，对于检测 1 摄氏度的信号是不适用 的，DS18B20 测温范围为-55℃到+125℃，在-10℃到+85℃范围内误差为±0.4°，精确性上优于热敏电阻。同时软件设计方面方案二简易程度要优于方案一，因此通过比较，最终选择方案二作为本系统的设计方案。

## 理论分析与计算

### 温度数据

DS18B20 测温范围为-55℃到+125℃，在-10℃到+85℃范围内误差为±0.4°。返 回 16 位二进制温度数值。

<div align=center><img  src ="https://github.com/zihaonian/Electronic-Design-Competition-AHJZU/blob/main/res/DS18B20 data register definition.jpg"/></div>

可知 16 位温度数值寄存器中，最低位表示 0.0625，即最终温度数据可 以精确到四位小数。

### 定时器配置

定时器初始化时需要配值相关寄存器以及计数初值。本系统使用挂载 12MHz 时钟 源的定时器 0，配置 50ms 的定时器，计算初值公式如下：

<center>T=（65535-n）/12MHz</center>

其中 n 为定时器初值，T 为所需的定时周期。对于 50ms 定时周期，算得初值为15536。

## 系统电路设计

### LCD1602 液晶屏

<div align=center><img  src ="https://github.com/zihaonian/Electronic-Design-Competition-AHJZU/blob/main/res/LCD1602 physical drawing.jpg"/></div>

主要参数：

•    显示字符:16×2 个字符

•    工作电压:4.5~5V

•    工作电流:2.0mA

•    工作温度：-20°C~70°C

•    模块最佳工作电压:5.0V

•    单个字符尺寸 2.95×4.35（W×Hmm）

•    引脚：16 脚

作为显示端显示相关信息，如学号、温度、时间等。

<div align=center><img  src ="https://github.com/zihaonian/Electronic-Design-Competition-AHJZU/blob/main/res/LCD1602 wiring diagram.jpg"/></div>

### DS18B20 温度传感器

DS18B20 是一款常用的高精度的单总线数字温度测量芯片。具有体积小，硬件开销低，抗干扰能力强，精度高的特点。测温范围为-55℃到+125℃，在-10℃到+85℃范围内误差为±0.4°。宽电压供电，电压 2.5V~5.5V。

DS18B20 内部含有 EEPROM ，通过配置寄存器可以设定数字转换精度和报警 温度，在系统掉电以后，它仍可保存分辨率及报警温度的设定值。

### DS1302 实时时钟

DS1302 是由美国 DALLAS 公司推出的具有涓细电流充电能力的低功耗实时时 钟芯片。它可以对年、月、日、周、时、分、秒进行计时，并且具有闰年补偿等 多种功能。

 DS1302 工作电压为 2.0V～5.5V。采用三线接口与 CPU 进行同步通信，并可 采用突发方式一次传送多个字节的时钟信号或 RAM 数据。DS1302 内部有一个31×8 的用于临时性存放数据的 RAM 寄存器。DS1302 增加了主电源/后备电源双 电源引脚，同时提供了对后备电源进行涓细电流充电的能力。

<div align=center><img  src ="https://github.com/zihaonian/Electronic-Design-Competition-AHJZU/blob/main/res/Pin-function diagram of the DS1302.jpg"/></div>

### 矩阵键盘

扫描原理：先从 P1 口的高四位（四个行）输出高电平，低四位（四个列）输出低电平， 假设有按键按下，从 P1 口的高四位读取键盘状态。判断高四位的四行哪一行变 成了低电平，就知道是第几行，再从 P1 口的低四位（四个列）输出高电平，高四位（四个行）输出低电平，从 P1 口的低四位读取键盘状态。判断低四位的四 列哪一行变成了低电平，就知道是第几列，将两次读取结果组合起来就可以得到 当前按键的特征编码。使用上述方法我们得到 16 个键的特征编码。

<div align=center><img  src ="https://github.com/zihaonian/Electronic-Design-Competition-AHJZU/blob/main/res/Matrix keypad wiring diagram.jpg"/></div>

## 系统软件设计

整个系统的功能是由硬件电路配合软件来实现的，当硬件基本定型后，软件的功能也就基本定下来了。从软件的功能不同可分为两大类：一是监控软件（主程序），它是整个控制系统的核心，专门用来协调各执行模块和操作者的关系。二是执行软件（子程序），它是用来完成各种实质性的功能如测量、计算、显示、通讯等。每一个执行软件也就是一个小的功能执行模块。

首先要根据系统的总体功能和键盘设置选择一种最合适的监控程序结构，然后根据实时性的要求，合理地安排监控软件和各执行模块之间地调度关系。

### 主程序方案

主程序调用了 5 个子程序，分别是 LCD 显示程序、键盘扫描以及按键处理程 序、温度读取程序、中断控制程序、单片机与 PC 机串口通讯程序。

1. 键盘扫描电路及按键处理程序：实现键盘的输入按键的识别及相关处 理。

2. 温度读取程序：对温度芯片送过来的数据进行处理，进行判断和显示。

3. LCD 显示程序：控制系统的显示部分，显示信息、温度数据以及时间等。

4. 中断控制程序：实现定时记录历史数据以及发送数据功能。

5. 串口通讯程序：实现 PC 机与单片机通讯，将温度数据传送给 PC 机。、

   各个功能程序以子程序的形式写好，当写主程序的时候，只需要调用子程序。然后在寄存器的分配上作一下调整，消除寄存器冲突和 I/O 冲突即可。 主程序流程图如下图:

<div align=center><img  src ="https://github.com/zihaonian/Electronic-Design-Competition-AHJZU/blob/main/res/Main program flow chart.jpg"/></div>

## 系统测试

### 分步调试

#### 测试环境及工具

测试温度：0~100 摄氏度。（模拟不同温度值环境）

测试仪器及软件：数字万用表，温度计 0~100 摄氏度，串口调试助手。

测试方法：目测。

#### 测试方法

使系统运行，观察系统硬件检测是否正常（包括单片机最小系统，键盘电路，显示电路，温度测试电路等）。系统自带测试表格数据，观察显示数据是否 相符合即可。采用温度传感器测试不同温度下的水温，目测显示电路是否正常。并记录各温度值，与实际温度值比较，得出系统的温度指标、测试数据回查功能是否正常运行，检查回查后的数据是否正确。 使用串口调试助手与单片机通讯，观察单片机与串口之间传输数据正确

#### 测试结果

| 记录次数 | 实时温度(^C) | 实时时间(时：分：秒) | 回查温度(^C) | 回查时间(时：分：秒) |
| -------- | ------------ | -------------------- | ------------ | -------------------- |
| 1        | 29.75        | 0：0：20             | 29.75        | 0：0：21             |
| 2        | 29.25        | 0：0：40             | 29.25        | 0：0：43             |
| 3        | 29.25        | 0：1：00             | 29.25        | 0：1：05             |
| 4        | 29.75        | 0：1：20             | 29.75        | 0：1：26             |
| 5        | 29.00        | 0：1：40             | 29.00        | 0：1：48             |
| 6        | 29.00        | 0：2：00             | 29.00        | 0：2：10             |
| 7        | 28.50        | 0：2：20             | 28.50        | 0：2：32             |
| 8        | 30.50        | 0：2：40             | 30.50        | 0：2：53             |
| 9        | 30.25        | 0：3：00             | 30.25        | 0：3：15             |
| 10       | 29.25        | 0：3：20             | 29.25        | 0：3：37             |

#### 测试结果分析

自检正常，多组温度显示正常，回查数据正常，串口传输数据正确。因为芯片是塑料封装，所以对温度的感应灵敏度不是相当高，需要一个很短的时间才能达到稳定。对于定时器，本系统设置了 50ms 定时器，定时次数最大为 400，即 20s 记录一次数据，当记录 200 个数时（即 10s），单片机向串口发送一次时间温度数据。但是实测来看平均记录周期略微有所误差，主要原因在于系统执行程序功能需要一定时间，改进的方法有简化系统程序代码等。

<center>50ms * 200 = 10s</center>

## 结论

在此次项目中，熟悉了 DS18B20 温度传感器·DS1302 实时时钟，矩阵键盘以 及 LCD1602 模块的用法。提高了串口通信，SPI 通信，单总线系统的理解。对于主程序逻辑构思更加清晰，增加了一定的实战经验。此项目设计基本完成了预期的目标，系统在硬件自动测试，键盘操作，实时 显示方面做的比较好。但是由于能力有限，设计成果并不是很完美，还存在下面 问题：液晶显示不够清晰，串口通讯不稳定，未对温度数值统计处理以及存储。 如加入温度数据处理函数使得温度数据显示更加稳定准确；修改 LCD 屏显函数使 其显示更加清除稳定等。由于经济实力有限，缺少语音播报模块，未完成对温度的播报要求。

## 附录

### 硬件原理图

<div align=center><img  src ="https://github.com/zihaonian/Electronic-Design-Competition-AHJZU/blob/main/res/Schematic.jpeg"/></div>

### 程序流程图

#### 中断流程图

<div align=center><img  src ="https://github.com/zihaonian/Electronic-Design-Competition-AHJZU/blob/main/res/Interrupt the procedure flowchart.jpg"/></div>

#### 温度读取流程图

<div align=center><img  src ="https://github.com/zihaonian/Electronic-Design-Competition-AHJZU/blob/main/res/Flow diagram of the temperature reading program.jpg"/></div>
